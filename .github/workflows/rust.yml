name: Rust

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  merge_group:
    branches: [ main, dev ]
  schedule:
    - cron: '0 8 * * *'  # Daily at midnight PST (8 AM UTC)
env:
  CARGO_TERM_COLOR: always
  CACHE_KEY_ID: 84f8acac52412db91407ab9f85776987da17d42f

jobs:
  build_ubuntu:

    runs-on: ubuntu-24.04

    defaults:
      run:
        working-directory: .

    steps:
    - uses: actions/checkout@v4
    - name: Install apt packages
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev libbsd-dev
    - name: Restore Cargo cache
      id: cargo-cache
      uses: actions/cache/restore@v5
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-${{ env.CACHE_KEY_ID }}
    - name: Setup on cache miss
      if: steps.cargo-cache.outputs.cache-hit != 'true'
      run: cargo xtask precheck --setup
    - name: Install nightly rustfmt
      run: cargo xtask rustup-component-add --component rustfmt --toolchain nightly
    - name: Install clippy
      run: cargo xtask rustup-component-add --component clippy
    - name: Run Copyright
      run: cargo xtask precheck --copyright
    - name: Run Audit
      run: cargo xtask precheck --audit
    - name: Cargo format
      run: cargo xtask precheck --fmt
    - name: Cargo Clippy
      run: cargo xtask precheck --clippy
    - name: SDK Run all mock tests table-4
      id: test-mock-table-4
      run: cargo xtask precheck --nextest --package azihsm_ddi --features mock,table-4 --profile ci-mock-table-4
      continue-on-error: true
    - name: SDK Run all mock tests table-64
      id: test-mock-table-64
      run: cargo xtask precheck --nextest --package azihsm_ddi --features mock,table-64 --profile ci-mock-table-64
      continue-on-error: true
    - name: Run all mock tests with code coverage
      id: test-mock-coverage
      run: cargo xtask precheck --coverage
      continue-on-error: true
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-ubuntu
        path: ./target/reports/
    - name: Generate nextest report
      id: nextest-report
      run: cargo xtask precheck --nextest-report
    - name: Fail if any tests failed
      if: ${{ steps.test-mock-coverage.outcome == 'failure' || steps.test-mock-table-4.outcome == 'failure' || steps.test-mock-table-64.outcome == 'failure' }}
      run: |
        echo "One or more tests failed."
        exit 1
  
  build_windows:

    runs-on: windows-latest

    defaults:
      run:
        working-directory: .

    steps:
    - uses: actions/checkout@v4
    - name: Restore Cargo cache
      id: cargo-cache
      uses: actions/cache/restore@v5
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-${{ env.CACHE_KEY_ID }}
    - name: Setup on cache miss
      if: steps.cargo-cache.outputs.cache-hit != 'true'
      run: cargo xtask precheck --setup
    - name: Install nightly rustfmt
      run: cargo xtask rustup-component-add --component rustfmt --toolchain nightly
    - name: Install clippy
      run: cargo xtask rustup-component-add --component clippy
    - name: Run Copyright
      run: cargo xtask precheck --copyright
    - name: Run Audit
      run: cargo xtask precheck --audit
    - name: Cargo format
      run: cargo xtask precheck --fmt
    - name: Cargo Clippy
      run: cargo xtask precheck --clippy
    - name: Run all mock tests with code coverage
      id: test-mock-coverage
      run: cargo xtask precheck --coverage
      continue-on-error: true
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-windows
        path: ./target/reports/
    - name: Generate nextest report
      id: nextest-report
      run: cargo xtask precheck --nextest-report
    - name: Fail if any tests failed
      if: ${{ steps.test-mock-coverage.outcome == 'failure' }}
      run: |
        echo "One or more tests failed."
        exit 1

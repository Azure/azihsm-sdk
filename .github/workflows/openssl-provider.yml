# Copyright (C) Microsoft Corporation. All rights reserved.

name: OpenSSL Provider Build

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build_openssl_provider_ubuntu:
    runs-on: ubuntu-${{ vars.UBUNTU_VER }}

    defaults:
      run:
        working-directory: .

    env:
      OPENSSL_COMMIT: 7e535fe6b16f3551252b336f911cee190ff4a4a6  # Pinned OpenSSL master commit

    steps:
    - name: Setup environment variables
      run: |
        echo "OPENSSL_INSTALL_DIR=${{ runner.temp }}/openssl-cache/build" >> $GITHUB_ENV
        echo "OPENSSL_SOURCE_DIR=${{ runner.temp }}/openssl-cache/source" >> $GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Restore OpenSSL build cache
      uses: actions/cache@v3
      id: cache-openssl
      with:
        path: ${{ runner.temp }}/openssl-cache/
        key: openssl-${{ runner.os }}-${{ env.OPENSSL_COMMIT }}
        restore-keys: |
          openssl-${{ runner.os }}-${{ env.OPENSSL_COMMIT }}

    - name: Install build dependencies
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential perl libbsd-dev

    - name: Clone OpenSSL repository
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        mkdir -p ${{ runner.temp }}/openssl-cache
        git clone https://github.com/openssl/openssl.git ${{ env.OPENSSL_SOURCE_DIR }}

    - name: Checkout OpenSSL commit
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        cd ${{ env.OPENSSL_SOURCE_DIR }}
        git checkout ${{ env.OPENSSL_COMMIT }}

    - name: Configure and build OpenSSL
      if: steps.cache-openssl.outputs.cache-hit != 'true'
      run: |
        cd ${{ env.OPENSSL_SOURCE_DIR }}
        ./Configure --prefix=${{ env.OPENSSL_INSTALL_DIR }} shared
        make -j$(nproc)
        make install

    - name: Build AZIHSM SDK
      run: cargo build --release

    - name: Build AZIHSM OpenSSL Provider
      run: |
        export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
        export LD_LIBRARY_PATH=${{ env.OPENSSL_INSTALL_DIR }}/lib:$LD_LIBRARY_PATH
        export PKG_CONFIG_PATH=${{ env.OPENSSL_INSTALL_DIR }}/lib/pkgconfig

        cd plugins/openssl
        make BUILD_TYPE=release ENABLE_WERROR=ON
